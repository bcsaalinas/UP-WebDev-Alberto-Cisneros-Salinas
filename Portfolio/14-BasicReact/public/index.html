<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Star Wars Watchlist</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <link rel="stylesheet" href="styles.css">
</head>

<body class="bg-dark text-light">
  <div class="container py-4">
    <header class="mb-3">
      <h1 class="fw-bold text-white mb-1">Star Wars Watchlist</h1>
      <p class="text-secondary mb-0">Hover a card to swap the poster for the faction logo. Click ‚ÄúMore...‚Äù to see the
        character and add your comment.</p>
    </header>

    <div id="cards" class="row g-3"></div>
    <div id="detail" class="card detail-card mt-4 d-none"></div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha256-3fp2dQK2g8bobtD4Zsa1+ltd0wC2BniQDrL7P5r3Qxc=" crossorigin="anonymous"></script>
  <script type="module">
    import sw from './data/data.js';

    const $cards = $('#cards');
    const $detail = $('#detail');

    const affiliationMeta = {
      Jedi: { logo: 'images/jedi.png', side: 'good' },
      Rebellion: { logo: 'images/rebel.png', side: 'good' },
      Sith: { logo: 'images/sith.png', side: 'evil' },
      Empire: { logo: 'images/empire.png', side: 'evil' },
    };

    const counts = {};
    const comments = {};
    sw.forEach((movie) => {
      counts[movie.episode] = { likes: 0, dislikes: 0 };
      comments[movie.episode] = [];
    });

    function makeCard(movie) {
      const meta = affiliationMeta[movie.best_character.affiliation] || {};
      return $(`
        <div class="col-12 col-sm-6 col-md-4">
          <div
            class="card h-100 shadow-sm movie-card"
            data-episode="${movie.episode}"
            data-poster="images/${movie.poster}"
            data-logo="${meta.logo || ''}"
            data-side="${meta.side || ''}">
            <div class="poster-wrap">
              <img class="poster" src="images/${movie.poster}" alt="${movie.title}">
            </div>
            <div class="card-body d-flex flex-column">
              <div class="mb-2">
                <h5 class="card-title mb-0 text-white">${movie.title}</h5>
                <small class="text-secondary">${movie.year}</small>
              </div>
              <div class="d-flex justify-content-between align-items-center mt-auto">
                <button class="btn btn-primary btn-sm more-btn" type="button">More...</button>
                <div class="btn-group btn-group-sm like-group">
                  <button class="btn btn-outline-success like-btn" type="button">üëç <span class="like-count">0</span></button>
                  <button class="btn btn-outline-danger dislike-btn" type="button">üëé <span class="dislike-count">0</span></button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `);
    }

    function renderCards() {
      sw.forEach((movie) => {
        $cards.append(makeCard(movie));
      });
    }

    function renderComments(list) {
      if (!list.length) {
        return '<p class="text-secondary small mb-0">No comments yet. Be the first!</p>';
      }
      return list
        .map(
          (entry) => `
            <div class="comment-card">
              <p class="fw-semibold mb-1 text-white">${entry.name}</p>
              <p class="mb-0 text-light small">${entry.text}</p>
            </div>
          `,
        )
        .join('');
    }

    function renderDetail(movie) {
      const meta = affiliationMeta[movie.best_character.affiliation] || {};
      const badgeClass = meta.side === 'good' ? 'text-bg-primary' : 'text-bg-danger';
      const currentComments = comments[movie.episode];
      $detail
        .attr('data-episode', movie.episode)
        .html(`
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
              <h2 class="h4 text-white mb-0">Episode ${movie.episode}: ${movie.title} (${movie.year})</h2>
              <span class="badge rounded-pill ${badgeClass}">
                ${movie.best_character.affiliation}
              </span>
            </div>
            <div class="row g-3 align-items-center detail-body">
              <div class="col-12 col-md-5">
                <img class="img-fluid rounded" src="images/${movie.best_character.image}" alt="${movie.best_character.name}">
              </div>
              <div class="col-12 col-md-7">
                <h3 class="h5 text-white">${movie.best_character.name}</h3>
                <p class="text-light small mb-0">${movie.best_character.bio}</p>
              </div>
            </div>
            <div class="mt-4">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h4 class="h6 text-white mb-0">Comments</h4>
              </div>
              <div id="comments-list" class="d-grid gap-2">${renderComments(currentComments)}</div>
              <form id="comment-form" class="mt-3">
                <div class="mb-2">
                  <input class="form-control" name="name" type="text" placeholder="Your name" required>
                </div>
                <div class="mb-2">
                  <textarea class="form-control" name="text" placeholder="Share your thoughts..." required></textarea>
                </div>
                <button class="btn btn-success btn-sm" type="submit">Post comment</button>
              </form>
            </div>
          </div>
        `)
        .removeClass('d-none');

      $detail.find('#comment-form').on('submit', function (event) {
        event.preventDefault();
        const name = this.name.value.trim();
        const text = this.text.value.trim();
        if (!name || !text) return;
        comments[movie.episode].push({ name, text });
        renderDetail(movie);
      });
    }

    function findMovie(episode) {
      return sw.find((m) => m.episode === String(episode));
    }

    $cards
      .on('mouseenter', '.movie-card', function () {
        const $card = $(this);
        const logo = $card.data('logo');
        const side = $card.data('side');
        if (logo) {
          $card.find('.poster').attr('src', logo).addClass('logo');
        }
        if (side === 'good') $card.addClass('good-side');
        if (side === 'evil') $card.addClass('evil-side');
      })
      .on('mouseleave', '.movie-card', function () {
        const $card = $(this);
        const poster = $card.data('poster');
        $card.find('.poster').attr('src', poster).removeClass('logo');
        $card.removeClass('good-side evil-side');
      })
      .on('click', '.more-btn', function () {
        const episode = $(this).closest('.movie-card').data('episode');
        const movie = findMovie(episode);
        if (movie) renderDetail(movie);
      })
      .on('click', '.like-btn', function () {
        const $card = $(this).closest('.movie-card');
        const episode = $card.data('episode');
        counts[episode].likes += 1;
        $card.find('.like-count').text(counts[episode].likes);
      })
      .on('click', '.dislike-btn', function () {
        const $card = $(this).closest('.movie-card');
        const episode = $card.data('episode');
        counts[episode].dislikes += 1;
        $card.find('.dislike-count').text(counts[episode].dislikes);
      });

    renderCards();
  </script>
</body>

</html>
